package teatro_moro_cot;

import java.util.Scanner;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.ArrayList;
import java.util.Set;
import java.util.HashSet;


public class Teatro_Moro_COT {
    static int entradasVendidas = 0;
    static List<String> boletaFinal = new ArrayList<>();
    static int gastoTotal = 0;
    static int precioNeto = 0;
    static int iva = 0;
    static String azul = "\033[34m";
    static Scanner scan = new Scanner(System.in);
    static int precioFinal = 0;

    // Variables para representar el estado de los asientos
    static Set<Integer> asientosVIP = new HashSet<>();
    static Set<Integer> asientosPlateaBaja = new HashSet<>();
    static Set<Integer> asientosPlateaAlta = new HashSet<>();
    static Set<Integer> asientosPalco = new HashSet<>();

    public static void main(String[] args) {
        int opcion = 0;

        do {
            System.out.println("Bienvenido al Teatro MORO, elija una de las siguientes opciones:");
            System.out.println("[1] Comprar");
            System.out.println("[2] Borrar Compra");
            System.out.println("[3] Lista de precios y descuentos");
            System.out.println("[4] Salir");
            opcion = scan.nextInt();
            scan.nextLine(); // Consume el carácter de nueva línea
            switch (opcion) {
                case 1:
                    comprar();
                    break;
                case 2:
                    borrar();
                    break;
                case 3:
                    descuentos();
                    break;
                case 4:
                    salir();
                    break;
                default:
                    System.out.println("Debe ingresar una opcion valida");
            }
        } while (opcion != 4);
    }

    static void comprar() {
        String tipoDeEntrada = "";
        int precioZona = 0;

        System.out.println("Por favor ingrese los datos solicitados");

        boolean match = false;

        do {
            System.out.print("Indique tipo de entrada (VIP, Platea baja, Platea alta o Palco): ");
            tipoDeEntrada = scan.nextLine().toLowerCase().trim();
            switch (tipoDeEntrada) {
                case "vip":
                    precioZona = 25000;
                    match = true;
                    break;
                case "platea baja":
                    precioZona = 19000;
                    match = true;
                    break;
                case "platea alta":
                    precioZona = 11000;
                    match = true;
                    break;
                case "palco":
                    precioZona = 7200;
                    match = true;
                    break;
                default:
                    System.out.println("Por favor ingrese un tipo de entrada valido");
            }
        } while (!match);

        mostrarAsientosDisponibles(tipoDeEntrada);

        boolean asientoValido = false;
        int asientoSeleccionado = 0;
        do {
            System.out.print("Por favor, seleccione el numero de asiento que desea comprar: ");
            asientoSeleccionado = scan.nextInt();
            scan.nextLine(); // Consume el carácter de nueva línea

            if (asientoDisponible(tipoDeEntrada, asientoSeleccionado)) {
                marcarAsiento(tipoDeEntrada, asientoSeleccionado);
                asientoValido = true;
            } else {
                System.out.println("Lo siento, este asiento ya esta ocupado o no existe.");
            }
        } while (!asientoValido);

        boolean edadValida = false;
        int edad = 0;
        do {
            System.out.print("Indique su edad: ");
            edad = scan.nextInt();
            scan.nextLine(); // Consume el carácter de nueva línea
            if (edad >= 1 && edad <= 130) {
                edadValida = true;
            } else {
                System.out.println("Por favor ingrese una edad valida");
            }
        } while (!edadValida);

        boolean tarifaValida = false;
        double descuentoEstudiante = 0;
        double descuentoEdad = 0;
        double descuentoEntradasVendidas = 0;
        do {
            System.out.print("Indique su tarifa (Estudiante o General): ");
            String tarifa = scan.nextLine().toLowerCase().trim();
            switch (tarifa) {
                case "estudiante":
                    descuentoEstudiante = 0.10;
                    tarifaValida = true;
                    break;
                case "general":
                    tarifaValida = true;
                    break;
                default:
                    System.out.println("Por favor ingrese una tarifa valida");
                    break;
            }
        } while (!tarifaValida);

        entradasVendidas++;

        if (entradasVendidas >= 3)
            descuentoEntradasVendidas = precioZona * 0.2;

        if (descuentoEstudiante != 0)
            descuentoEstudiante = precioZona * 0.1;

        if (edad >= 60)
            descuentoEdad = precioZona * 0.15;

        precioFinal = (int) (precioZona - descuentoEdad - descuentoEstudiante - descuentoEntradasVendidas);

        gastoTotal += precioFinal;
        precioNeto = (int) Math.round(gastoTotal / 1.19);
        iva = (int) Math.round((gastoTotal / 1.19) * 0.19);

        String aplicaDescuentoEstudiante = (descuentoEstudiante != 0) ? "Descuento Estudiante: 10%\n" : "";
        String aplicaDescuentoEdad = (descuentoEdad != 0) ? "Descuento Tercera edad: 15%\n" : "";
        String aplicaDescuentoEntradasVendidas = (descuentoEntradasVendidas != 0) ? "Promocion compra 3 entradas o mas: 20%\n" : "";

        String boleta = ("----------------------------------\n" +
                "Zona: " + tipoDeEntrada + "\n" +
                "Asiento: " + asientoSeleccionado + "\n" +
                "Precio base: $" + precioZona + "\n" +
                aplicaDescuentoEstudiante +
                aplicaDescuentoEdad +
                aplicaDescuentoEntradasVendidas +
                "Precio final: $" + precioFinal + " pesos\n");

        System.out.println(boleta);

        boletaFinal.add(boleta);
    }

    static void borrar() {
        if (boletaFinal.isEmpty()) {
            System.out.println("No hay compras para borrar.");
            return;
        }

        System.out.println("Seleccione el numero de compra que desea borrar:");
        for (int i = 0; i < boletaFinal.size(); i++) {
            System.out.println((i + 1) + ". Compra:");
            System.out.println(boletaFinal.get(i));
        }

        int numeroBoleta = scan.nextInt();
        scan.nextLine(); // Consume el carácter de nueva línea
        if (numeroBoleta < 1 || numeroBoleta > boletaFinal.size()) {
            System.out.println("Numero de compra invalido.");
            return;
        }

        // Obtener la boleta seleccionada
        String boletaBorrada = boletaFinal.remove(numeroBoleta - 1);

        // Extraer el tipo de entrada y el número de asiento de la boleta borrada
        String tipoDeEntrada = obtenerTipoDeEntrada(boletaBorrada);
        int numeroAsiento = Integer.parseInt(boletaBorrada.split("Asiento: ")[1].split("\n")[0]);

        // Restar el precio de la boleta borrada del gasto total
        int precioBorrado = Integer.parseInt(boletaBorrada.split("Precio final: ")[1].split(" ")[0].replaceAll("[^\\d.]", ""));
        gastoTotal -= precioBorrado;

        // Decrementar el número de entradas vendidas
        entradasVendidas--;

        // Marcar el asiento correspondiente como disponible nuevamente
        switch (tipoDeEntrada) {
            case "vip":
                asientosVIP.remove(numeroAsiento);
                break;
            case "platea baja":
                asientosPlateaBaja.remove(numeroAsiento);
                break;
            case "platea alta":
                asientosPlateaAlta.remove(numeroAsiento);
                break;
            case "palco":
                asientosPalco.remove(numeroAsiento);
                break;
        }

        System.out.println("La compra ha sido borrada exitosamente.");
        System.out.println("");
        System.out.println("");
    }

    static boolean asientoDisponible(String tipoDeEntrada, int numeroAsiento) {
        switch (tipoDeEntrada) {
            case "vip":
                return !asientosVIP.contains(numeroAsiento) && numeroAsiento >= 1 && numeroAsiento <= 9;
            case "platea baja":
                return !asientosPlateaBaja.contains(numeroAsiento) && numeroAsiento >= 1 && numeroAsiento <= 9;
            case "platea alta":
                return !asientosPlateaAlta.contains(numeroAsiento) && numeroAsiento >= 1 && numeroAsiento <= 9;
            case "palco":
                return !asientosPalco.contains(numeroAsiento) && numeroAsiento >= 1 && numeroAsiento <= 9;
            default:
                return false;
        }
    }

    static void marcarAsiento(String tipoDeEntrada, int numeroAsiento) {
        switch (tipoDeEntrada) {
            case "vip":
                asientosVIP.add(numeroAsiento);
                break;
            case "platea baja":
                asientosPlateaBaja.add(numeroAsiento);
                break;
            case "platea alta":
                asientosPlateaAlta.add(numeroAsiento);
                break;
            case "palco":
                asientosPalco.add(numeroAsiento);
                break;
        }
    }

    static String obtenerTipoDeEntrada(String boleta) {
        String[] lineas = boleta.split("\n");
        return lineas[1].split(": ")[1];
    }

    static void mostrarAsientosDisponibles(String tipoDeEntrada) {
        System.out.println("Asientos disponibles para " + tipoDeEntrada + ":");
        switch (tipoDeEntrada) {
            case "vip":
                for (int i = 1; i <= 9; i++) {
                    if (!asientosVIP.contains(i)) {
                        System.out.print("[" + i + "] ");
                    } else {
                        System.out.print("[X] ");
                    }
                }
                break;
            case "platea baja":
                for (int i = 1; i <= 9; i++) {
                    if (!asientosPlateaBaja.contains(i)) {
                        System.out.print("[" + i + "] ");
                    } else {
                        System.out.print("[X] ");
                    }
                }
                break;
            case "platea alta":
                for (int i = 1; i <= 9; i++) {
                    if (!asientosPlateaAlta.contains(i)) {
                        System.out.print("[" + i + "] ");
                    } else {
                        System.out.print("[X] ");
                    }
                }
                break;
            case "palco":
                for (int i = 1; i <= 9; i++) {
                    if (!asientosPalco.contains(i)) {
                        System.out.print("[" + i + "] ");
                    } else {
                        System.out.print("[X] ");
                    }
                }
                break;
        }
        System.out.println();
    }

    static void descuentos() {
        System.out.println("\n-------------------------------------------------------------");
        System.out.println("TEATRO MORO");
        System.out.println("LISTA DE PRECIOS");
        System.out.println("VIP: $25.000");
        System.out.println("Platea baja: $19.000");
        System.out.println("Platea alta: $11.000");
        System.out.println("Palco: $7.200\n");
        System.out.println("DESCUENTOS");
        System.out.println("Estudiante: 10%");
        System.out.println("Tercera edad (a partir de 60 años): 15%");
        System.out.println("Promocion compra 3 entradas o mas: 20%");
        System.out.println("-------------------------------------------------------------\n");
    }

    static void salir() {
        String dateTime = DateTimeFormatter.ofPattern("      dd-MM-yyy, HH:mm ").format(LocalDateTime.now());
        System.out.println("\n\n\n\n\n\n\n\n");
        System.out.println(azul + "DETALLE DE COMPRA:");
        for (int i = 0; i < boletaFinal.size(); i++) {
            System.out.println(boletaFinal.get(i));
        }
        System.out.println(azul + "===== BOLETA ELECTRONICA =====");
        System.out.println(azul + "=====     TEATRO MORO    =====");
        System.out.println(dateTime);
        System.out.println("      Entradas compradas: " + entradasVendidas);
        System.out.println("      Neto  : $" + precioNeto);
        System.out.println("      IVA   : $" + iva);
        System.out.println("      TOTAL : $" + gastoTotal + "\n");
        System.out.println(azul + "=== GRACIAS POR PREFERIRNOS ===");
    }
}
